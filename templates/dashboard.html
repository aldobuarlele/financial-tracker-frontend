<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Financial Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container d-flex justify-content-between">
            <span class="navbar-brand mb-0 h1">üí∞ Financial Tracker</span>
            <div class="d-flex align-items-center">
                <span class="text-white me-3 fw-bold">Halo, {{ username }}</span>
                <a href="/logout" class="btn btn-sm btn-danger">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <h2 class="mb-0">Dashboard</h2>
                <a href="/kalender" class="btn btn-outline-primary btn-sm">üìÖ Kalender</a>
                <a href="/statistik" class="btn btn-outline-dark btn-sm">üìä Laporan</a>
            </div>
            
            <div class="d-flex gap-2">
                <a href="/tambah?mode=INCOME" class="btn btn-success btn-lg shadow-sm">+ Masuk</a>
                <a href="/tambah?mode=EXPENSE" class="btn btn-danger btn-lg shadow-sm">- Keluar</a>
                <a href="/tambah?mode=TRANSFER" class="btn btn-primary btn-lg shadow-sm">‚áÑ Transfer</a>
            </div>
        </div>

        <div class="alert alert-info shadow-sm d-flex justify-content-between align-items-center">
            <span class="fs-5">
                {% if role == 'PARENT' %}
                    Total Aset Keluarga:
                {% else %}
                    Total Aset User:
                {% endif %}
            </span>
            <strong class="fs-3">Rp {{ "{:,.0f}".format(total_saldo).replace(',', '.') }}</strong>
        </div>

        <div class="row mb-4">
            {% for wallet in wallets %}
            <div class="col-md-4">
                <div class="card shadow-sm mb-3 border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5 class="card-title mb-0">{{ wallet.walletName }}</h5>
                            <span class="badge bg-light text-dark border">{{ wallet.walletType }}</span>
                        </div>
                        <div class="mt-2 text-muted small">
                            Milik: <strong>{{ family_members.get(wallet.userId, 'Unknown') }}</strong>
                        </div>
                        <h3 class="text-success mt-3 mb-0">
                            Rp {{ "{:,.0f}".format(wallet.balance).replace(',', '.') }}
                        </h3>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="row">
            
            <div class="col-md-8 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Riwayat Transaksi</h4>
                    <form action="/" method="GET" class="d-flex gap-2">
                        <input type="text" name="q" class="form-control form-control-sm" placeholder="Cari transaksi..." value="{{ search_query }}">
                        <button type="submit" class="btn btn-secondary btn-sm">Cari</button>
                    </form>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th class="ps-3">Tanggal</th>
                                    <th>Oleh</th>
                                    <th>Kategori</th>
                                    <th>Ket</th>
                                    <th class="text-end pe-3">Jumlah</th>
                                    <th style="width: 50px;"></th> 
                                </tr>
                            </thead>
                            <tbody>
                                {% for t in transactions %}
                                <tr>
                                    <td class="ps-3 text-muted small">{{ t.transactionDate[:10] }}</td>
                                    <td>
                                        <span class="badge bg-info text-dark">{{ family_members.get(t.userId, 'Unknown') }}</span>
                                    </td>
                                    <td>
                                        {% if t.transactionType == 'TRANSFER' %}
                                            <span class="badge bg-primary">TRANSFER</span>
                                        {% elif t.category %}
                                            <span class="badge bg-secondary">{{ t.category.name }}</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ t.description }}</td>
                                    <td class="text-end pe-3 fw-bold 
                                        {% if t.transactionType == 'INCOME' %} text-success 
                                        {% elif t.transactionType == 'EXPENSE' %} text-danger 
                                        {% else %} text-primary {% endif %}">
                                        
                                        {% if t.transactionType == 'INCOME' %}+
                                        {% elif t.transactionType == 'EXPENSE' %}-
                                        {% else %}‚áÑ{% endif %} 
                                        Rp {{ "{:,.0f}".format(t.amount).replace(',', '.') }}
                                    </td>
                                    
                                    <td class="text-center d-flex gap-1 justify-content-end">
                                        <a href="/edit/{{ t.id }}" class="btn btn-sm btn-outline-warning border-0" title="Edit">
                                            ‚úèÔ∏è
                                        </a>
                                        <form action="/hapus/{{ t.id }}" method="POST" onsubmit="return confirm('Yakin ingin menghapus transaksi ini?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger border-0" title="Hapus">
                                                üóëÔ∏è
                                            </button>
                                        </form>
                                    </td>

                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-4 text-muted">
                                        {% if search_query %}
                                            Tidak ditemukan transaksi dengan kata kunci "{{ search_query }}".
                                        {% else %}
                                            Belum ada transaksi keluarga.
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <h4 class="mb-3">Analisis Keuangan</h4>
                
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-header bg-danger text-white">Pengeluaran</div>
                    <div class="card-body">
                        <canvas id="expenseChart"></canvas>
                        {% if not expense_values %}
                            <p class="text-center text-muted mt-3 small">Belum ada data.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-header bg-success text-white">Pemasukan</div>
                    <div class="card-body">
                        <canvas id="incomeChart"></canvas>
                        {% if not income_values %}
                            <p class="text-center text-muted mt-3 small">Belum ada data.</p>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <div class="mb-5"></div>

    <script>
        // Chart Pengeluaran
        const ctxExp = document.getElementById('expenseChart');
        // 'default([])' mencegah error jika data kosong/undefined
        const expLabels = {{ expense_labels | tojson | default([]) }};
        const expData = {{ expense_values | tojson | default([]) }};

        if (expData.length > 0) {
            new Chart(ctxExp, {
                type: 'doughnut',
                data: {
                    labels: expLabels,
                    datasets: [{
                        data: expData,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                    }]
                },
                options: { 
                    plugins: { 
                        legend: { position: 'bottom' }
                    } 
                }
            });
        }

        // Chart Pemasukan
        const ctxInc = document.getElementById('incomeChart');
        const incLabels = {{ income_labels | tojson | default([]) }};
        const incData = {{ income_values | tojson | default([]) }};

        if (incData.length > 0) {
            new Chart(ctxInc, {
                type: 'doughnut',
                data: {
                    labels: incLabels,
                    datasets: [{
                        data: incData,
                        backgroundColor: ['#2ecc71', '#3498db', '#9b59b6', '#f1c40f', '#e67e22'],
                    }]
                },
                options: { 
                    plugins: { 
                        legend: { position: 'bottom' }
                    } 
                }
            });
        }
    </script>
</body>
</html>